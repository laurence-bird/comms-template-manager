@import com.ovoenergy.comms.templates.model.RequiredTemplateData
@import views.ViewHelper._
@(templateData: RequiredTemplateData.obj)(implicit user: com.gu.googleauth.UserIdentity, messages: Messages)
@main{
    <link rel="stylesheet" href="@routes.Assets.at("stylesheets/test.css")">

    <div class="page-header">
        <h1>Test a template</h1>
    </div>

    <script type="text/javascript">
        const idCounterRegex = /\[([0-9]+)\]$/g;

        function manageOptionalField(checkboxId, optionalId) {
           var escapedOptionalId = optionalId
                   .replace(/\./g, "\\.")
                   .replace(/\]/g, "\\]")
                   .replace(/\[/g, "\\[");
           if (document.getElementById(checkboxId).checked === false) {
               $("input[id^=" + escapedOptionalId + "\\.]").each(function () {
                    $(this).prop('disabled', true);
                    $(this).prop('required', false);
               });
               $("input[id=" + escapedOptionalId + "]").each(function () {
                   $(this).prop('disabled', true);
                   $(this).prop('required', false);
               });
            } else {
               $("input[id^=" + escapedOptionalId + "\\.]").each(function () {
                   $(this).prop('disabled', false);
                   $(this).prop('required', true);
               });
               $("input[id=" + escapedOptionalId + "]").each(function () {
                   $(this).prop('disabled', false);
                   $(this).prop('required', true);
               });
            }
        }

        function clearChildren(element) {
            for (var i = 0; i < element.childNodes.length; i++) {
                var e = element.childNodes[i];
                if (e.tagName) switch (e.tagName.toLowerCase()) {
                    case 'input':
                        e.value = '';
                        break;
                    default: clearChildren(e);
                }
            }
        }

        function replaceIds(element, oldParentId, newParentId) {

            function getNewAttributeValue(oldValue) {
             return oldValue.replace(oldParentId, newParentId);
            }

            for (var i = 0; i < element.childNodes.length; i++) {
                var e = element.childNodes[i];
                if (e.tagName) {
                    switch (e.tagName.toLowerCase()) {
                        case 'input':
                            if (e.hasAttribute("id")) e.id = getNewAttributeValue(e.id);
                            if (e.hasAttribute("name")) e.name = getNewAttributeValue(e.name);
                            break;
                        default:
                            if (e.hasAttribute("id")) e.id = getNewAttributeValue(e.id);
                            if (e.hasAttribute("for")) e.setAttribute("for", getNewAttributeValue(e.getAttribute("for")));
                            if (e.hasAttribute("name")) e.name = getNewAttributeValue(e.name);
                            replaceIds(e, oldParentId, newParentId);
                    }
                }
            }
        }

        function addElement(parentId, buttonId) {
            var parentElement = document.getElementById(parentId);
            var children = parentElement.children;
            var itm = children[children.length - 1];
            var newNode = itm.cloneNode(true);

            var oldId = newNode.id;
            var newIdCounter = parseInt(idCounterRegex.exec(oldId)[1]) + 1;
            var newId = oldId.replace(idCounterRegex, "[" + newIdCounter + "]");

            clearChildren(newNode);
            replaceIds(newNode, oldId, newId);
            newNode.value = "";
            newNode.id = newId;

            parentElement.appendChild(newNode);

            (function($) {
                $.fn.goTo = function() {
                    $('html, body').animate({
                        scrollTop: $(this).offset().top - 100
                    }, 'fast');
                    return this; // for chaining...
                }
            })(jQuery);
            $('*[id=' + buttonId).goTo();
        }

        function removeElement(parentId, buttonId) {
            var parentElement = document.getElementById(parentId);
            var children = parentElement.children;
            var lastChild = children[children.length-1];
            parentElement.removeChild(lastChild);

            (function($) {
                $.fn.goTo = function() {
                    $('html, body').animate({
                        scrollTop: $(this).offset().top - 100
                    }, 'fast');
                    return this; // for chaining...
                }
            })(jQuery);
            $('*[id=' + buttonId).goTo();


        }

    </script>

    @helper.form(action = routes.MainController.processTemplate()) {

        <div>
            <legend class="template-legend">FYI Passed in obj</legend>
            <span>@templateData</span>
            <br><br>
        </div>

        <form class="form-horizontal">
            <fieldset>
                <legend class="template-legend">Enter Details</legend>

                @Html(recurseRequiredTemplateData(None, templateData.fields))

                <div class="form-group  col-md-12">
                    <div class="col-lg-8">
                        <button type="submit" id="publish" class="btn btn-primary">Publish Template</button>
                    </div>
                </div>

            </fieldset>
        </form>

    }
}